#!/bin/bash
#┌───────────────────┐
#│ Список переменных │
#└───────────────────┘
RCFILE='.64.bash_profile'      # Путь к файлу bash-конфигурации для shell-входа
IP_ADDRESS='root@192.168.1.82' # Адрес сервера

#┌────────────────────────────────────────┐
#│ Список переменных окружения на сервере │
#└────────────────────────────────────────┘
ENV_OPTS=(
    PATH_WORKSPACE="$PATH_WORKSPACE" # Путь к рабочему каталогу
)

#┌────────────────────────────┐
#│ Список опций для ssh-входа │
#└────────────────────────────┘
SSH_OPTS=(
    -o LogLevel=QUIET               # Выводим только важные сообщения (тихий режим)
    -o UserKnownHostsFile=/dev/null # Не сохраняем ключ в known_hosts
    -o StrictHostKeyChecking=no     # Отключаем проверку ключа (вход без подтверждения)
)

#┌───────────────────────────────────────┐
#│ Список опций для синхронизации файлов │
#└───────────────────────────────────────┘
RSYNC_OPTS=(
    -q                             # Тихий режим
    -a                             # Архивный режим
    --del                          # Удалять лишние файлы на сервере
    --delete-excluded              # Также удалять файлы, исключённые через --exclude
    --exclude='dev'                # Не копировать dev
    --exclude='start'              # Не копировать start
    --exclude='.git'               # Не копировать .git
    --exclude='.gitignore'         # Не копировать .gitignore
    --exclude-from='.gitignore'    # Не копировать список файлов и папок в файле .gitignore
    "$PATH_WORKSPACE/"             # Источник откуда копируем файлы
    "$IP_ADDRESS:$PATH_WORKSPACE/" # Цель куда копируем файлы
)

#┌───────────────────────────┐
#│ Список пакетов на клиенте │
#└───────────────────────────┘
PACKAGES_CLIENT=(
    rsync   # Синхронизация файлов между клиентом и сервером
    sshpass # Вход без ввода пароля
)

#┌───────────────────────────┐
#│ Список пакетов на сервере │
#└───────────────────────────┘
PACKAGES_SERVER=(
    rsync # Синхронизация файлов между клиентом и сервером
    bash  # Основная оболочка командной строки
)

#┌─────────────────────────────────┐
#│ Устанавливает пакеты на клиенте │
#└─────────────────────────────────┘
install_packages_client() {
# Локальные переменные
    local pkg
    
# Проходим по списку пакетов
    for pkg in "${PACKAGES_CLIENT[@]}"; do
    # Устанавливаем пакет
        apk add "$pkg" > /dev/null 2>&1 || {
            echo 'Ошибка!'
            echo "Не удалось установить пакет: $pkg"
            exit 1
        }
    done
}

#┌─────────────────────────────────┐
#│ Устанавливает пакеты на сервере │
#└─────────────────────────────────┘
install_packages_server() {
    sshpass -p 1 ssh "${SSH_OPTS[@]}" "$IP_ADDRESS" <<EOF || exit 1
    # Проходим по списку пакетов
        for pkg in ${PACKAGES_SERVER[*]}; do
        # Устанавливаем пакет
            apk add "\$pkg" > /dev/null 2>&1
            
        # Установка не была завершена
            if [ \$? != 0 ]; then
                echo 'Ошибка!'
                echo "Не удалось установить пакет: \$pkg"
                exit 1
            fi
        done
EOF
}

#┌────────────────────────────────────┐
#│ Проверяем путь к рабочему каталогу │
#└────────────────────────────────────┘
[ -z "$PATH_WORKSPACE" ] && {
    echo 'Ошибка!'
    echo 'Путь к рабочему каталогу не задан!'
    exit 1
}

#┌─────────────────────────────────┐
#│ Устанавливаем пакеты на клиенте │
#└─────────────────────────────────┘
echo '1/4 Устанавливаем пакеты на клиенте...'
install_packages_client

#┌─────────────────────────────────┐
#│ Устанавливаем пакеты на сервере │
#└─────────────────────────────────┘
echo '2/4 Устанавливаем пакеты на сервере...'
install_packages_server

#┌──────────────────────┐
#│ Синхронизируем файлы │
#└──────────────────────┘
echo '3/4 Синхронизируем файлы...'
sshpass -p 1 rsync -e "ssh ${SSH_OPTS[*]}" "${RSYNC_OPTS[@]}" > /dev/null

#┌──────────────────┐
#│ Входим на сервер │
#└──────────────────┘
echo '4/4 Входим на сервер...'
sshpass -p 1 ssh -t "${SSH_OPTS[@]}" "$IP_ADDRESS" env "${ENV_OPTS[@]}" bash --rcfile "$PATH_WORKSPACE/$RCFILE"
